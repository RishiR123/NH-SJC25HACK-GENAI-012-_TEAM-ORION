<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post-Sales - Sales OS powered by Theta</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.png') }}" type="image/x-icon">
    <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* DESIGN PRINCIPLES APPLIED:
         * Primary Accent: #C0FF6B (Neon Green)
         * Base Background: #050507
         * Glass Panels: rgba(255, 255, 255, 0.06) with blur(25px)
         * Soft Borders: rgba(255, 255, 255, 0.15)
         * Text Primary: #F5F7FA
         * Text Secondary: #9CA3AF
         * Typography: Inter
        */

        /* DESIGN PRINCIPLES APPLIED:
 * Primary Accent: #7C3AED (Deep Purple)
 * Base Background: linear-gradient(135deg, #EAD9FF 0%, #FBE8F3 100%)
 * Glass Panels: rgba(255, 255, 255, 0.45) with blur(24px)
 * Soft Borders: rgba(0, 0, 0, 0.1)
 * Text Primary: #000000 (Dark Slate)
 * Text Secondary: #000000 (Medium Slate)
 * Typography: Inter
*/

/* General Reset and Box Sizing */
html { box-sizing: border-box; }
*, *::before, *::after { box-sizing: inherit; transition: all 0.3s ease; }

body {
    margin: 0;
    height: 100vh;
    display: flex;
    background: linear-gradient(135deg, #EAD9FF 0%, #FBE8F3 100%);
    font-family: 'Inter', sans-serif;
    overflow: hidden;
    color: #000000; /* Dark Slate */
}

/* Scrollbar for Light Theme */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 8px; }
::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.25); }

/* Sidebar container styling for the matte glass effect */
.sidebar {
    position: fixed;
    left: 0; top: 0;
    width: 220px;
    height: 100vh;
    background: rgba(255, 255, 255, 0.45); /* Light glass */
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    display: flex;
    flex-direction: column;
    z-index: 3;
    border-right: 1px solid rgba(0, 0, 0, 0.1); /* Soft dark border */
}
.sidebar.hidden { left: -220px; }
.sidebar-header { display: flex; justify-content: flex-start; align-items: center; padding: 20px; border-bottom: 1px solid rgba(0, 0, 0, 0.1); }
.logo-img { max-width: 120px; height: auto; cursor: pointer; transition: opacity 0.3s ease; }
.logo-img:hover { opacity: 0.8; }
.nav { flex: 1; padding: 15px; overflow-y: auto; }
.nav ul { list-style: none; padding: 0; margin: 0; }
.nav li { margin: 5px 0; cursor: pointer; position: relative; }
.nav a { text-decoration: none; color: inherit; }
.nav-item { padding: 12px 15px; display: flex; align-items: center; gap: 15px; position: relative; border-radius: 16px; color: #000000; /* Medium Slate */ }
.nav li:hover .nav-item { background: rgba(0, 0, 0, 0.05); /* Soft dark hover */ color: #000000; /* Dark Slate */ }
.nav li.active .nav-item { background: #7C3AED; /* Deep Purple */ color: #FFFFFF; /* White */ font-weight: 600; }
.nav li.active .nav-item::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); height: 60%; width: 4px; background-color: #FFFFFF; border-radius: 0 4px 4px 0; }
.nav li.active .nav-item svg { fill: #FFFFFF; }
.nav svg { width: 20px; height: 20px; fill: #000000; /* Medium Slate */ }
.nav li:hover .nav-item svg { fill: #000000; /* Dark Slate */ }
.nav .dropdown-arrow { position: absolute; right: 15px; }
.nav li.open .dropdown-arrow { transform: rotate(180deg); }
.submenu { list-style: none; padding: 5px 0 5px 35px; margin: 0; max-height: 0; overflow: hidden; }
.submenu a { font-size: 0.9em; color: #000000; /* Medium Slate */ }
.nav li.open > .submenu { max-height: 200px; }
.submenu li { padding: 8px 15px; border-radius: 12px; }
.submenu li:hover { background: rgba(0, 0, 0, 0.05); }
.submenu li:hover a { color: #000000; /* Dark Slate */ }
.submenu li.active a { color: #7C3AED; /* Deep Purple */ font-weight: 500; }
.bottom-section { padding: 15px; border-top: 1px solid rgba(0, 0, 0, 0.1); margin-top: auto; display: flex; flex-direction: column; gap: 10px; }
.profile { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 5px; border-radius: 16px; }
.profile:hover { background: rgba(0, 0, 0, 0.05); }
.profile-icon-container { width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; overflow: hidden; }
.profile-icon { width: 24px; height: 24px; fill: #000000; /* Medium Slate */ }
.profile-icon-img { width: 100%; height: 100%; object-fit: cover; }
.profile-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; color: #000000; /* Dark Slate */ }
.footer-links { list-style: none; padding: 0; margin: 0; }
.footer-links li { padding: 10px 10px; display: flex; align-items: center; gap: 8px; cursor: pointer; border-radius: 12px; color: #000000; /* Medium Slate */ }
.footer-links li:hover { color: #7C3AED; background: rgba(0, 0, 0, 0.05); }
.footer-links li:hover svg { fill: #7C3AED; }
.footer-links svg { width: 18px; height: 18px; fill: #000000; /* Medium Slate */ }
.toggle-btn { width: 36px; height: 36px; background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(10px); border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; z-index: 5; position: fixed; top: 20px; right: 20px; border: 1px solid rgba(0, 0, 0, 0.05); transition: all 0.3s ease; }
.toggle-btn:hover { background: rgba(255, 255, 255, 0.7); transform: translateY(-2px); }
.toggle-btn span { display: block; width: 20px; height: 2px; background: #000000; /* Dark Slate */ margin: 2px 0; border-radius: 2px; transition: all 0.3s ease; }
.sidebar.hidden ~ .toggle-btn { right: 20px; }
.main-container { flex: 1; margin-left: 220px; display: flex; height: 100vh; overflow: hidden; }
.sidebar.hidden ~ .main-container { margin-left: 0; }
.main-content { flex: 1; padding: 40px; display: flex; flex-direction: column; gap: 25px; min-width: 0; overflow-y: auto; }
.main-content header h1 { font-size: 2em; font-weight: 600; color: #000000; /* Dark Slate */ margin:0; }
.main-content header p { margin-top: 5px; color: #000000; /* Medium Slate */ }

/* Table styling for Light/Glassmorphism */
.table-wrapper {
    background: rgba(255, 255, 255, 0.45); /* Light glass */
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 24px;
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
}
.table-container { overflow-y: auto; flex-grow: 1; padding: 10px; }
.post-sales-table { width: 100%; border-collapse: collapse; text-align: left; }
.post-sales-table th, .post-sales-table td { padding: 15px; border-bottom: 1px solid rgba(0, 0, 0, 0.1); white-space: nowrap; }
.post-sales-table tr:last-child td { border-bottom: none; }
.post-sales-table th { font-weight: 600; color: #000000; /* Dark Slate */ background-color: rgba(255, 255, 255, 0.5); /* Semi-transparent white sticky header */ position: sticky; top: -11px; z-index: 1; backdrop-filter: blur(10px); }
.post-sales-table th:first-child, .post-sales-table td:first-child { width: 40px; text-align: center; }
.post-sales-table input[type="checkbox"] { appearance: none; background-color: transparent; border: 2px solid #000000; /* Medium Slate */ width: 18px; height: 18px; border-radius: 6px; cursor: pointer; position: relative; vertical-align: middle; }
.post-sales-table input[type="checkbox"]:hover { border-color: #7C3AED; }
.post-sales-table input[type="checkbox"]:checked { background-color: #7C3AED; /* Deep Purple */ border-color: #7C3AED; }
.post-sales-table input[type="checkbox"]:checked::after { content: 'âœ”'; font-size: 14px; color: #FFFFFF; /* White checkmark */ position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); line-height: 1; }
.post-sales-table tbody tr { cursor: pointer; color: #000000; /* Medium Slate */ }
.post-sales-table tbody tr:hover { background: rgba(0, 0, 0, 0.05); color: #000000; /* Dark Slate */ }
.post-sales-table tbody tr.active { background-color: rgba(124, 58, 237, 0.1); /* Light purple background */ box-shadow: inset 3px 0 0 #7C3AED; /* Deep Purple indicator */ color: #000000; /* Dark Slate */ }

/* Health Badges - Adjusted colors for light background visibility */
.health-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.8em; font-weight: 500; display: inline-flex; align-items: center; gap: 5px; }
.health-excellent { background-color: rgba(124, 58, 237, 0.2); color: #7C3AED; /* Deep Purple */ }
.health-good { background-color: rgba(96, 165, 250, 0.2); color: #2563eb; /* Darker blue */ }
.health-at-risk { background-color: rgba(245, 158, 11, 0.2); color: #d97706; /* Darker orange */ }
.health-poor { background-color: rgba(239, 68, 68, 0.2); color: #dc2626; /* Darker red */ }

/* Status Badges - Adjusted colors for light background visibility */
.status-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.8em; font-weight: 500; }
.status-active { background-color: rgba(124, 58, 237, 0.2); color: #7C3AED; }
.status-churned { background-color: rgba(239, 68, 68, 0.2); color: #dc2626; }

/* Lead Details Panel */
#lead-details-panel {
    width: 450px;
    flex-shrink: 0;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    background-color: rgba(255, 255, 255, 0.6); /* Lighter panel background */
    backdrop-filter: blur(30px);
}
#lead-details-panel.hidden { display: none; }
.panel-header { padding: 25px 30px; border-bottom: 1px solid rgba(0, 0, 0, 0.1); flex-shrink: 0; position: relative; }
.panel-header h2 { font-size: 1.5em; margin: 0; font-weight: 600; color: #000000; /* Dark Slate */ }
.panel-header p { color: #000000; /* Medium Slate */ font-size: 0.9em; margin: 4px 0 0; }
#close-panel-btn { position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 2em; color: #000000; /* Dark Slate */ cursor: pointer; }
#close-panel-btn:hover { color: #7C3AED; }
.panel-body { flex-grow: 1; padding: 25px 30px; overflow-y: auto; }
.panel-section { margin-bottom: 25px; }
.panel-section h3 { font-size: 1.1em; font-weight: 500; margin: 0 0 15px 0; padding-bottom: 8px; border-bottom: 1px solid rgba(0, 0, 0, 0.1); color: #000000; /* Dark Slate */ }

/* AI Summary Bubble */
.ai-summary {
    background: rgba(0, 0, 0, 0.05); /* Soft dark background for insight bubble */
    border: 1px solid rgba(0, 0, 0, 0.1);
    padding: 15px;
    border-radius: 16px;
    font-size: 0.9em;
    line-height: 1.6;
    margin-top: 15px;
    color: #000000; /* Dark Slate */
}
.ai-summary strong { color: #7C3AED; /* Deep Purple */ }

.task-control-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
.task-control-item { display: flex; align-items: center; justify-content: space-between; background: rgba(0, 0, 0, 0.05); padding: 10px; border-radius: 12px; font-size: 0.9em; color: #000000; /* Medium Slate */ }

/* Toggle Switch Styling */
.toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.15); border-radius: 24px; }
.slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: #FFFFFF; /* White knob */ border-radius: 50%; }
input:checked + .slider { background-color: #7C3AED; /* Deep Purple checked state */ }
input:checked + .slider:before { transform: translateX(20px); background-color: #FFFFFF; }

textarea {
    width: 100%;
    padding: 12px 15px;
    background: rgba(255, 255, 255, 0.45); /* Light glass input */
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 16px;
    color: #000000; /* Dark Slate text */
    outline: none;
    font-size: 1em;
    font-family: 'Inter', sans-serif;
    resize: vertical;
    min-height: 80px;
    backdrop-filter: blur(10px);
}
textarea:focus { border-color: #7C3AED; box-shadow: 0 0 15px rgba(124, 58, 237, 0.2); }
textarea::placeholder { color: rgba(0, 0, 0, 0.6); }

/* Tabs (No tabs in this HTML, but including for consistency if they were added later) */
.panel-tabs { display: flex; gap: 10px; border-bottom: 1px solid rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
.panel-tab { padding: 10px 15px; cursor: pointer; background: none; border: none; color: #000000; /* Medium Slate */ font-family: 'Inter', sans-serif; font-size: 0.9em; border-bottom: 2px solid transparent; }
.panel-tab.active { border-bottom: 2px solid #7C3AED; color: #7C3AED; /* Deep Purple */ font-weight: 500; }
.panel-tab-pane { display: none; }
.panel-tab-pane.active { display: block; }

/* Action Button */
.panel-action-button {
    background: #7C3AED; /* Solid Deep Purple accent button */
    color: #FFFFFF;
    border: none;
    padding: 10px 16px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
}
.panel-action-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4);
}
.panel-action-button:disabled { background: rgba(0, 0, 0, 0.1); color: rgba(0, 0, 0, 0.4); cursor: not-allowed; box-shadow: none; }

@media(max-width: 1024px) {
    #lead-details-panel { position: fixed; right: 0; top: 0; height: 100%; width: 350px; transform: translateX(100%); transition: transform 0.3s ease-in-out; z-index: 50; }
    #lead-details-panel.active { transform: translateX(0); }
    #lead-details-panel.hidden { transform: translateX(100%); }
}
@media(max-width: 768px) { .sidebar { left: -220px; } .sidebar.active { left: 0; } .main-container { margin-left: 0; } .toggle-btn { right: 20px; } }
</style>
</head>
<body>
    <div class="toggle-btn" id="toggleBtn"><span></span><span></span><span></span></div>    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img class="logo-img" src="/static/logo.png" alt="Sales OS Logo" onerror="this.onerror=null;this.src='https://placehold.co/120x40/050507/C0FF6B?text=SalesOS&font=inter';">
        </div>
        <div class="nav">
            <ul>
                <li ><a href="/space"><div class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>Space</div></a></li>
                <li id="crmMenu">
                    <div class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 13h6v-2H4v2zm0 4h6v-2H4v2zm0-8h6V7H4v2zm8 2h9V7h-9v2zm0 4h9v-2h-9v2zm0 4h9v-2h-9v2z"/></svg>MIni-Crm<svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg></div>
                    <ul class="submenu"><li><a href="/mini-crm/leads">Leads</a></li><li><a href="/mini-crm/deals">Deals</a></li><li><a href="/mini-crm/sales-funnel">Sales Funnel</a></li></ul>
                </li>
                <li><a href="/calendar"><div class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>Calendar</div></a></li>

                <li id="salesMenu">
                    <div class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-2 .89-2 2v11c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zM10 4h4v2h-4V4zm10 15H4V8h16v11z"/></svg>Sales<svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg></div>
                    <ul class="submenu">
                        <li><a href="/sales/pre-sales">Pre-Sales</a></li>
                        <li class="active"><a href="/sales/post-sales">Post-Sales</a></li>
                    </ul>
                </li>
                <li><div class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c-1.1 0-2 .9-2 2s.9 2 2 2s2-.9 2-2s-.9-2-2-2zm0-4c-1.1 0-2 .9-2 2s.9 2 2 2s2-.9 2-2s-.9-2-2-2zm0-4c-1.1 0-2 .9-2 2s.9 2 2 2s2-.9 2-2s-.9-2-2-2zm-4 4c-1.1 0-2 .9-2 2s.9 2 2 2s2-.9 2-2s-.9-2-2-2zm8 0c-1.1 0-2 .9-2 2s.9 2 2 2s2-.9 2-2s-.9-2-2-2z"/></svg>Agent Connect</div></li>
            </ul>
        </div>
        
        <div class="bottom-section">
            <div class="profile">
                <div class="profile-icon-container">
                    <img id="profile-img" src="" alt="User Profile" class="profile-icon-img hidden" onerror="this.classList.add('hidden'); document.getElementById('default-profile-icon').classList.remove('hidden');">
                    <svg id="default-profile-icon" class="profile-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                </div>
                <span class="profile-name" id="profile-name"></span>
            </div>

            <ul class="footer-links">
                <li id="settings-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.08-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.08.49 0 .61.22l2-3.46c.12-.22.07.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/>
                    </svg>
                    Settings
                </li>
                <li id="logout-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M16 13v-2H7v-2h9V7l5 4l-5 4zm-5 6h9V4h-9v3H9V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2h-9a2 2 0 0 1-2-2v-3h2v3z"/>
                    </svg>
                    Log Out
                </li>
            </ul>
        </div>
    </div>

    <div class="main-container">
        <main class="main-content">
            <header>
                <h1>Post-Sales AI Cockpit</h1>
                <p>Nurture and grow customer relationships with intelligent assistance.</p>
            </header>
            <div class="table-wrapper">
                <div class="table-container">
                    <table class="post-sales-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox"></th>
                                <th>Account Name</th>
                                <th>Status</th>
                                <th>Health Score</th>
                                <th>Renewal Date</th>
                                <th>Owner</th>
                            </tr>
                        </thead>
                        <tbody id="accounts-tbody">
                            <!-- Rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
        
        <aside id="lead-details-panel" class="hidden">
             <!-- Panel will be populated by JavaScript -->
        </aside>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE & AUTHENTICATION ---
            let allAccountsData = [];
            const token = localStorage.getItem('jwt_token');

            function parseJwt(token) {
                try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }
            }

            if (!token) { window.location.href = '/auth'; return; }
            const decodedToken = parseJwt(token);
            if (!decodedToken || decodedToken.exp * 1000 < Date.now()) {
                localStorage.removeItem('jwt_token');
                window.location.href = '/auth';
                return;
            }
            const userName = decodedToken.name || 'User';
            
            // --- UI ELEMENTS ---
            const accountsTbody = document.getElementById('accounts-tbody');
            const leadDetailsPanel = document.getElementById('lead-details-panel');

            // --- API HELPER ---
            async function apiRequest(endpoint, method = 'GET', body = null) {
                const options = { method, headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } };
                if (body) options.body = JSON.stringify(body);
                const response = await fetch(endpoint, options);
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || `HTTP error! status: ${response.status}`);
                }
                return response.json();
            }

            // --- DATA FETCHING ---
            async function initializeApp() {
                document.getElementById('profile-name').textContent = userName;
                try {
                    const accounts = await apiRequest('/postsales/accounts');
                    allAccountsData = accounts;
                    renderAccountsTable();
                } catch (error) {
                    console.error("Failed to fetch accounts:", error);
                    accountsTbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Error: ${error.message}</td></tr>`;
                }
            }

            // --- RENDER FUNCTIONS ---
            const getHealthBadge = (score) => {
                if (!score) return '<span>-</span>';
                const scoreClass = score.toLowerCase().replace(' ', '-');
                return `<span class="health-badge health-${scoreClass}">${score}</span>`;
            };
            const getStatusBadge = (stage) => {
                const status = (stage === 'Closed-Won') ? 'Active' : 'Churned';
                const statusClass = status.toLowerCase();
                return `<span class="status-badge status-${statusClass}">${status}</span>`;
            }

            const renderAccountsTable = () => {
                if (allAccountsData.length === 0) {
                    accountsTbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No active accounts found.</td></tr>';
                    return;
                }
                accountsTbody.innerHTML = allAccountsData.map(acc => `
                    <tr data-account-id="${acc.id}">
                        <td><input type="checkbox"></td>
                        <td>${acc.name}</td>
                        <td>${getStatusBadge(acc.stage)}</td>
                        <td>${getHealthBadge(acc.ai_health_score)}</td>
                        <td>${acc.renewal_date ? new Date(acc.renewal_date).toLocaleDateString() : 'N/A'}</td>
                        <td>${userName}</td>
                    </tr>
                `).join('');
            };
            
            const renderAccountDetails = (account) => {
                const aiTasks = account.ai_tasks || {};
                leadDetailsPanel.innerHTML = `
                    <div class="panel-header">
                        <button id="close-panel-btn" class="lg:hidden">&times;</button>
                        <h2>${account.name}</h2>
                        <p>Primary Contact: ${account.contact_name || 'N/A'}</p>
                        <div class="ai-summary">
                            <strong>AI Summary:</strong>
                            <span id="ai-summary-text">${account.ai_summary || 'No summary generated yet.'}</span>
                            <button id="generate-summary-btn" class="panel-action-button" style="margin-left: 10px; display: ${account.ai_summary ? 'none' : 'inline-block'};">Generate</button>
                        </div>
                    </div>
                    <div class="panel-body">
                         <div class="panel-section">
                            <h3>AI Task Control</h3>
                            <div class="task-control-grid">
                                ${['Check-ins', 'QBR Prep', 'Support Triage', 'Upsell/Cross-sell', 'Feedback', 'Reporting'].map(task => `
                                <div class="task-control-item">
                                    <label for="task-${task.toLowerCase()}">${task}</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" class="ai-task-toggle" data-task="${task}" id="task-${task.toLowerCase()}" ${aiTasks[task] ? 'checked' : ''}>
                                        <span class="slider"></span>
                                    </label>
                                </div>`).join('')}
                            </div>
                        </div>
                        <div class="panel-section">
                            <h3>Instruct AI</h3>
                            <textarea id="ai-instruction-input" rows="3" placeholder="e.g., Summarize all support tickets from the last 30 days..."></textarea>
                            <div style="text-align: right; margin-top: 10px;">
                                <button id="instruct-ai-btn" class="panel-action-button">Send Instruction</button>
                            </div>
                            <div id="ai-instruction-response" class="ai-summary" style="margin-top: 15px; display: none; white-space: pre-wrap; word-wrap: break-word;"></div>
                        </div>
                    </div>
                `;
                leadDetailsPanel.classList.remove('hidden');
                if (window.innerWidth <= 1024) leadDetailsPanel.classList.add('active');
                attachPanelEventListeners(account.id);
            };

            // --- EVENT HANDLERS ---
            function attachPanelEventListeners(dealId) {
                document.getElementById('close-panel-btn')?.addEventListener('click', closePanel);
                document.getElementById('generate-summary-btn')?.addEventListener('click', async (e) => {
                    const btn = e.target;
                    btn.textContent = 'Generating...';
                    btn.disabled = true;
                    try {
                        const updatedAccount = await apiRequest(`/deals/${dealId}/generate_summary`, 'POST');
                        const index = allAccountsData.findIndex(a => a.id === dealId);
                        if (index !== -1) allAccountsData[index] = updatedAccount;
                        renderAccountsTable();
                        renderAccountDetails(updatedAccount);
                    } catch (error) {
                        console.error("Summary generation failed:", error);
                        alert("Could not generate summary.");
                        btn.textContent = 'Generate';
                        btn.disabled = false;
                    }
                });
                
                document.getElementById('instruct-ai-btn')?.addEventListener('click', async (e) => {
                    const btn = e.target;
                    const instructionInput = document.getElementById('ai-instruction-input');
                    const responseContainer = document.getElementById('ai-instruction-response');
                    const instruction = instructionInput.value.trim();

                    if (!instruction) return;

                    btn.textContent = 'Processing...';
                    btn.disabled = true;
                    responseContainer.style.display = 'none';

                    try {
                        const result = await apiRequest(`/deals/${dealId}/instruct_ai`, 'POST', { instruction: instruction });
                        responseContainer.innerHTML = `<strong>AI Response:</strong><br>${result.response || 'Completed.'}`;
                        responseContainer.style.display = 'block';

                    } catch (error) {
                        console.error("AI instruction failed:", error);
                        responseContainer.innerHTML = `<strong>Error:</strong> ${error.message}`;
                        responseContainer.style.display = 'block';
                    } finally {
                        btn.textContent = 'Send Instruction';
                        btn.disabled = false;
                    }
                });

                document.querySelectorAll('.ai-task-toggle').forEach(toggle => {
                    toggle.addEventListener('change', async (e) => {
                        const task = e.target.dataset.task;
                        const enabled = e.target.checked;
                        try {
                            await apiRequest(`/deals/${dealId}/ai_tasks`, 'PUT', { task, enabled });
                            const account = allAccountsData.find(a => a.id === dealId);
                            if (account) {
                                if (!account.ai_tasks) account.ai_tasks = {};
                                account.ai_tasks[task] = enabled;
                            }
                        } catch (error) {
                            console.error(`Failed to update task ${task}:`, error);
                            alert(`Could not update task state for ${task}.`);
                            e.target.checked = !enabled;
                        }
                    });
                });
            }

            function closePanel() {
                if (window.innerWidth <= 1024) leadDetailsPanel.classList.remove('active');
                else leadDetailsPanel.classList.add('hidden');
                document.querySelector('.post-sales-table tr.active')?.classList.remove('active');
            }

            const handleRowClick = (e) => {
                const row = e.target.closest('tr');
                if (!row || !row.dataset.accountId) return;
                document.querySelectorAll('#accounts-tbody tr').forEach(tr => tr.classList.remove('active'));
                row.classList.add('active');
                const accountId = parseInt(row.dataset.accountId, 10);
                const accountData = allAccountsData.find(l => l.id === accountId);
                if (accountData) renderAccountDetails(accountData);
            };

            // --- INITIALIZE ---
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('toggleBtn');
            const salesMenu = document.getElementById('salesMenu');
            const logoutBtn = document.getElementById('logout-btn');
            const settingsBtn = document.getElementById('settings-btn');
            const logoImg = document.querySelector('.logo-img');
            
            toggleBtn.addEventListener('click', () => { sidebar.classList.toggle('hidden'); toggleBtn.classList.toggle('visible'); });
            salesMenu.addEventListener('click', (e) => { e.stopPropagation(); salesMenu.classList.toggle('open'); });
            
            document.getElementById('crmMenu').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('crmMenu').classList.toggle('open');
            });
            logoutBtn.addEventListener('click', () => { localStorage.removeItem('jwt_token'); window.location.href = '/auth'; });
            settingsBtn.addEventListener('click', () => { window.location.href = '/settings'; });
            if (logoImg) {
                logoImg.addEventListener('click', () => { window.location.href = '/'; });
            }
            accountsTbody.addEventListener('click', handleRowClick);
            
            initializeApp();
        });
    </script>
</body>
</html>
