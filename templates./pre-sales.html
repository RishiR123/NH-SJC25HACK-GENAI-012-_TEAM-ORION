<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-Sales - Sales OS powered by Theta</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="shortcut icon" href="https://placehold.co/32x32/EAD9FF/7C3AED?text=S&font=inter" type="image/x-icon">
    <link rel="icon" href="https://placehold.co/32x32/EAD9FF/7C3AED?text=S&font=inter" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* DESIGN PRINCIPLES APPLIED:
         * Primary Accent: #7C3AED (Deep Purple)
         * Base Background: linear-gradient(135deg, #EAD9FF 0%, #FBE8F3 100%)
         * Glass Panels: rgba(255, 255, 255, 0.45) with blur(24px)
         * Soft Borders: rgba(0, 0, 0, 0.1)
         * Text Primary: #000000 (Dark Slate)
         * Text Secondary: #000000 (Medium Slate)
         * Typography: Inter
        */

        /* General Reset and Box Sizing */
        html { box-sizing: border-box; }
        *, *::before, *::after { box-sizing: inherit; transition: all 0.3s ease; }

        body {
            margin: 0;
            height: 100vh;
            display: flex;
            background: linear-gradient(135deg, #EAD9FF 0%, #FBE8F3 100%);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            color: #000000; /* Dark Slate */
        }

        /* Scrollbar for Light Theme */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 8px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.25); }

        /* Sidebar container styling for the matte glass effect */
        .sidebar {
            position: fixed;
            left: 0; top: 0;
            width: 220px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.45); /* Light glass */
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            display: flex;
            flex-direction: column;
            z-index: 3;
            border-right: 1px solid rgba(0, 0, 0, 0.1); /* Soft dark border */
        }
        .sidebar.hidden { left: -220px; }
        .sidebar-header { display: flex; justify-content: flex-start; align-items: center; padding: 20px; border-bottom: 1px solid rgba(0, 0, 0, 0.1); }
         /* Note: Using placeholder logo */
        .logo-img { max-width: 120px; height: auto; cursor: pointer; transition: opacity 0.3s ease; }
        .logo-img:hover { opacity: 0.8; }
        .nav { flex: 1; padding: 15px; overflow-y: auto; }
        .nav ul { list-style: none; padding: 0; margin: 0; }
        .nav li { margin: 5px 0; cursor: pointer; position: relative; }
        .nav a { text-decoration: none; color: inherit; }
        .nav-item { padding: 12px 15px; display: flex; align-items: center; gap: 15px; position: relative; border-radius: 16px; color: #000000; /* Medium Slate */ }
        .nav li:hover .nav-item { background: rgba(0, 0, 0, 0.05); /* Soft dark hover */ color: #000000; /* Dark Slate */ }
        .nav li.active .nav-item { background: #7C3AED; /* Deep Purple */ color: #FFFFFF; /* White */ font-weight: 600; }
        .nav li.active .nav-item::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); height: 60%; width: 4px; background-color: #FFFFFF; border-radius: 0 4px 4px 0; }
        .nav li.active .nav-item svg { fill: #FFFFFF; }
        .nav svg { width: 20px; height: 20px; fill: #000000; /* Medium Slate */ }
        .nav li:hover .nav-item svg { fill: #000000; /* Dark Slate */ }
        .nav .dropdown-arrow { position: absolute; right: 15px; }
        .nav li.open .dropdown-arrow { transform: rotate(180deg); }
        .submenu { list-style: none; padding: 5px 0 5px 35px; margin: 0; max-height: 0; overflow: hidden; }
        .submenu a { font-size: 0.9em; color: #000000; /* Medium Slate */ }
        .nav li.open > .submenu { max-height: 200px; }
        .submenu li { padding: 8px 15px; border-radius: 12px; }
        .submenu li:hover { background: rgba(0, 0, 0, 0.05); }
        .submenu li:hover a { color: #000000; /* Dark Slate */ }
        .submenu li.active a { color: #7C3AED; /* Deep Purple */ font-weight: 500; }
        .bottom-section { padding: 15px; border-top: 1px solid rgba(0, 0, 0, 0.1); margin-top: auto; display: flex; flex-direction: column; gap: 10px; }
        .profile { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 5px; border-radius: 16px; }
        .profile:hover { background: rgba(0, 0, 0, 0.05); }
        .profile-icon-container { width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .profile-icon { width: 24px; height: 24px; fill: #000000; /* Medium Slate */ }
        .profile-icon-img { width: 100%; height: 100%; object-fit: cover; }
        .profile-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; color: #000000; /* Dark Slate */ }
        .footer-links { list-style: none; padding: 0; margin: 0; }
        .footer-links li { padding: 10px 10px; display: flex; align-items: center; gap: 8px; cursor: pointer; border-radius: 12px; color: #000000; /* Medium Slate */ }
        .footer-links li:hover { color: #7C3AED; background: rgba(0, 0, 0, 0.05); }
        .footer-links li:hover svg { fill: #7C3AED; }
        .footer-links svg { width: 18px; height: 18px; fill: #000000; /* Medium Slate */ }
        .toggle-btn { width: 36px; height: 36px; background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(10px); border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; z-index: 5; position: fixed; top: 20px; right: 20px; border: 1px solid rgba(0, 0, 0, 0.05); transition: all 0.3s ease; }
        .toggle-btn:hover { background: rgba(255, 255, 255, 0.7); transform: translateY(-2px); }
        .toggle-btn span { display: block; width: 20px; height: 2px; background: #000000; /* Dark Slate */ margin: 2px 0; border-radius: 2px; transition: all 0.3s ease; }
        .sidebar.hidden ~ .toggle-btn { right: 20px; } /* Adjust if needed based on sidebar state */

        .main-container { flex: 1; margin-left: 220px; display: flex; height: 100vh; overflow: hidden; transition: margin-left 0.3s ease; }
        .sidebar.hidden ~ .main-container { margin-left: 0; }

        .main-content { flex: 1; padding: 40px; display: flex; flex-direction: column; gap: 25px; min-width: 0; overflow-y: auto; }
        .main-content header h1 { font-size: 2em; font-weight: 600; color: #000000; /* Dark Slate */ margin:0; }
        .main-content header p { margin-top: 5px; color: #000000; /* Medium Slate */ }

        /* Table styling for Light/Glassmorphism */
        .table-wrapper {
            background: rgba(255, 255, 255, 0.45); /* Light glass */
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 24px;
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        .table-container { overflow-y: auto; flex-grow: 1; padding: 10px; }
        .pre-sales-table { width: 100%; border-collapse: collapse; text-align: left; }
        .pre-sales-table th, .pre-sales-table td { padding: 15px; border-bottom: 1px solid rgba(0, 0, 0, 0.1); white-space: nowrap; }
        .pre-sales-table tr:last-child td { border-bottom: none; }
        .pre-sales-table th { font-weight: 600; color: #000000; /* Dark Slate */ background-color: rgba(255, 255, 255, 0.5); /* Semi-transparent white sticky header */ position: sticky; top: -11px; z-index: 1; backdrop-filter: blur(10px); }
        .pre-sales-table th:first-child, .pre-sales-table td:first-child { width: 40px; text-align: center; }
        .pre-sales-table input[type="checkbox"] { appearance: none; background-color: transparent; border: 2px solid #000000; /* Medium Slate */ width: 18px; height: 18px; border-radius: 6px; cursor: pointer; position: relative; vertical-align: middle; }
        .pre-sales-table input[type="checkbox"]:hover { border-color: #7C3AED; }
        .pre-sales-table input[type="checkbox"]:checked { background-color: #7C3AED; /* Deep Purple */ border-color: #7C3AED; }
        .pre-sales-table input[type="checkbox"]:checked::after { content: '✔'; font-size: 14px; color: #FFFFFF; /* White checkmark */ position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); line-height: 1; }
        .pre-sales-table tbody tr { cursor: pointer; color: #000000; /* Medium Slate */ }
        .pre-sales-table tbody tr:hover { background: rgba(0, 0, 0, 0.05); color: #000000; /* Dark Slate */ }
        .pre-sales-table tbody tr.active { background-color: rgba(124, 58, 237, 0.1); /* Light purple background */ box-shadow: inset 3px 0 0 #7C3AED; /* Deep Purple indicator */ color: #000000; /* Dark Slate */ }

        /* Score Badges */
        .score-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.8em; font-weight: 500; display: inline-flex; align-items: center; gap: 5px; }
        .score-hot { background-color: rgba(239, 68, 68, 0.2); color: #dc2626; /* Darker red */ }
        .score-warm { background-color: rgba(245, 158, 11, 0.2); color: #d97706; /* Darker orange */ }
        .score-cold { background-color: rgba(96, 165, 250, 0.2); color: #2563eb; /* Darker blue */ }
        .score-error { background-color: rgba(255, 0, 0, 0.1); color: red; } /* Style for error state */

        /* *** NEW: REGENERATE BUTTON STYLE *** */
        .regenerate-btn {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #000000;
            padding: 4px 8px;
            font-size: 0.8em;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }
        .regenerate-btn:hover {
            background: rgba(0, 0, 0, 0.1);
            border-color: rgba(0, 0, 0, 0.15);
        }
        .regenerate-btn:disabled {
            background: rgba(0, 0, 0, 0.05);
            color: rgba(0, 0, 0, 0.4);
            cursor: not-allowed;
        }

        /* Lead Details Panel */
        #lead-details-panel {
            width: 450px;
            flex-shrink: 0;
            border-left: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            background-color: rgba(255, 255, 255, 0.6); /* Lighter panel background */
            backdrop-filter: blur(30px);
            transition: transform 0.3s ease, width 0.3s ease; /* Added width transition */
        }
        #lead-details-panel.hidden {
            width: 0; /* Animate width to 0 when hidden */
            padding: 0;
            border-left: none;
            overflow: hidden;
            transform: translateX(10px); /* Optional slight slide */
        }

        .panel-header { padding: 25px 30px; border-bottom: 1px solid rgba(0, 0, 0, 0.1); flex-shrink: 0; position: relative; }
        .panel-header h2 { font-size: 1.5em; margin: 0; font-weight: 600; color: #000000; /* Dark Slate */}
        .panel-header p { color: #000000; /* Medium Slate */ font-size: 0.9em; margin: 4px 0 0; }
        #close-panel-btn { position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 2em; color: #000000; /* Dark Slate */ cursor: pointer; line-height: 1; }
        #close-panel-btn:hover { color: #7C3AED; }

        .panel-body { flex-grow: 1; padding: 25px 30px; overflow-y: auto; }
        .panel-section { margin-bottom: 25px; }
        .panel-section h3 { font-size: 1.1em; font-weight: 500; margin: 0 0 15px 0; padding-bottom: 8px; border-bottom: 1px solid rgba(0, 0, 0, 0.1); color: #000000; /* Dark Slate */ }

        .ai-insight {
            background: rgba(0, 0, 0, 0.05); /* Soft dark background */
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 15px;
            border-radius: 16px;
            font-size: 0.9em;
            line-height: 1.6;
            margin-top: 15px;
            color: #000000; /* Dark Slate */
            min-height: 4em; /* Reserve space during loading */
        }
        .ai-insight strong { color: #7C3AED; /* Deep Purple */ }

        .task-control-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .task-control-item { display: flex; align-items: center; justify-content: space-between; background: rgba(0, 0, 0, 0.05); padding: 10px; border-radius: 12px; font-size: 0.9em; color: #000000; /* Medium Slate */ }

        /* Toggle Switch Styling */
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.15); border-radius: 24px; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: #FFFFFF; /* White knob */ border-radius: 50%; transition: .4s; }
        input:checked + .slider { background-color: #7C3AED; /* Deep Purple checked state */ }
        input:checked + .slider:before { transform: translateX(20px); background-color: #FFFFFF; }

        .action-item {
            background: rgba(0, 0, 0, 0.05);
            padding: 15px;
            border-radius: 16px;
            border-left: 3px solid #7C3AED; /* Deep Purple indicator */
            font-size: 0.9em;
            margin-bottom: 10px;
            color: #000000; /* Dark Slate */
            min-height: 3em; /* Reserve space */
        }

        textarea {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.45); /* Light glass input */
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 16px;
            color: #000000; /* Dark Slate text */
            outline: none;
            font-size: 1em;
            font-family: 'Inter', sans-serif;
            resize: vertical;
            min-height: 80px;
            backdrop-filter: blur(10px);
        }
        textarea:focus { border-color: #7C3AED; box-shadow: 0 0 15px rgba(124, 58, 237, 0.2); }
        textarea::placeholder { color: rgba(0, 0, 0, 0.6); }

        .panel-action-button {
            background: #7C3AED; /* Solid Deep Purple */
            color: #FFFFFF;
            border: none;
            padding: 10px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
        }
        .panel-action-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4);
        }
        .panel-action-button:disabled { background: rgba(0, 0, 0, 0.1); color: rgba(0, 0, 0, 0.4); cursor: not-allowed; box-shadow: none; }

        /* Skeleton Loading */
        .skeleton {
            animation: skeleton-loading 1.5s linear infinite alternate;
            background-color: rgba(0, 0, 0, 0.08); /* Darker skeleton */
            border-radius: 8px;
            color: transparent !important;
            user-select: none;
            cursor: progress;
            display: inline-block;
            vertical-align: middle; /* Align better with text */
        }
        @keyframes skeleton-loading {
            0% { background-color: rgba(0, 0, 0, 0.08); }
            100% { background-color: rgba(0, 0, 0, 0.12); }
        }
        .skeleton-text { height: 1em; margin-bottom: 0.5em; }
        .skeleton-text:last-child { margin-bottom: 0; }

        /* Responsive */
        @media(max-width: 1024px) {
            #lead-details-panel {
                position: fixed; right: 0; top: 0; height: 100%;
                width: 350px; /* Adjust width as needed for tablets/smaller laptops */
                transform: translateX(100%); z-index: 50;
                border-left: 1px solid rgba(0, 0, 0, 0.1); /* Ensure border is added back */
                 /* Remove width:0 when active */
                 padding: 0; /* Reset padding */
            }
             #lead-details-panel:not(.hidden) {
                padding: initial; /* Restore padding when not hidden */
            }
            #lead-details-panel.active { transform: translateX(0); width: 350px; }
            #lead-details-panel.hidden {
                 transform: translateX(100%);
                 width: 350px; /* Keep width consistent for animation */
                 /* Let transition handle hiding */
                 pointer-events: none; /* Prevent interaction when hidden */
            }
        }
        @media(max-width: 768px) {
            .sidebar { left: -220px; }
            .sidebar.active { left: 0; } /* Need JS to add/remove 'active' */
            .main-container { margin-left: 0; }
            .toggle-btn { right: initial; left: 20px; /* Move toggle to left for mobile */ }
             #lead-details-panel { width: 90%; /* Make panel wider on mobile */ }
             #lead-details-panel.active { width: 90%; }
             #lead-details-panel.hidden { width: 90%; }
             .main-content { padding: 20px; }
             .panel-header { padding: 20px; }
             .panel-body { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="toggle-btn" id="toggleBtn"><span></span><span></span><span></span></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="/static/logo.png"
                 alt="SalesOS Logo"
                 class="logo-img"
                 onerror="this.onerror=null;this.src='https://placehold.co/120x40/050507/C0FF6B?text=SalesOS&font=inter';">

        </div>
        <div class="nav">
            <ul>
                <li><a href="/space"><div class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>Space</div></a></li>
                <li id="crmMenu">
                    <div class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 13h6v-2H4v2zm0 4h6v-2H4v2zm0-8h6V7H4v2zm8 2h9V7h-9v2zm0 4h9v-2h-9v2zm0 4h9v-2h-9v2z"/></svg>Mini-Crm<svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg></div>
                    <ul class="submenu"><li><a href="/mini-crm/leads">Leads</a></li><li><a href="/mini-crm/deals">Deals</a></li><li><a href="/mini-crm/sales-funnel">Sales Funnel</a></li></ul>
                </li>
                <li><a href="/calendar"><div class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>Calendar</div></a></li>

                <li id="salesMenu" class="open"> <div class="nav-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-2 .89-2 2v11c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zM10 4h4v2h-4V4zm10 15H4V8h16v11z"/></svg>Sales<svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg></div>
                    <ul class="submenu">
                        <li class="active"><a href="/sales/pre-sales">Pre-Sales</a></li>
                        <li><a href="/sales/post-sales">Post-Sales</a></li>
                    </ul>
                </li>
                 </ul>
        </div>

        <div class="bottom-section">
             <div class="profile">
                <div class="profile-icon-container">
                    <img id="profile-img" src="" alt="User Profile" class="profile-icon-img hidden" onerror="this.classList.add('hidden'); document.getElementById('default-profile-icon').classList.remove('hidden');">
                    <svg id="default-profile-icon" class="profile-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                </div>
                <span class="profile-name" id="profile-name"></span>
            </div>
            <ul class="footer-links">
                <li id="settings-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.08-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59 1.69.98l2.49 1c.23.08.49 0 .61.22l2-3.46c.12-.22.07.49-.12.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg> Settings
                </li>
                <li id="logout-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 13v-2H7v-2h9V7l5 4l-5 4zm-5 6h9V4h-9v3H9V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2h-9a2 2 0 0 1-2-2v-3h2v3z"/></svg> Log Out
                </li>
            </ul>
        </div>
    </div>

    <div class="main-container">
        <main class="main-content">
            <header>
                <h1>Pre-Sales AI Cockpit</h1>
                <p>Manage and accelerate your leads with intelligent insights.</p>
            </header>
            <div class="table-wrapper">
                <div class="table-container">
                    <table class="pre-sales-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox"></th>
                                <th>Lead Name</th>
                                <th>Company</th>
                                <th>Status</th>
                                <th>Score</th>
                                <th>Owner</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leads-tbody">
                            <tr><td colspan="7" style="text-align:center;">Loading leads...</td></tr> </tbody>
                    </table>
                </div>
            </div>
        </main>

        <aside id="lead-details-panel" class="hidden">
             <div class="panel-header"><p>Select a lead to see details.</p></div>
        </aside>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE & AUTHENTICATION ---
            let allLeadsData = []; // Holds only the currently loaded page(s)
            let orgUsers = {}; // Cache for user names (can be added later if needed)
            
            // *** FIX: Use 'jwt_token' to match your auth logic ***
            const token = localStorage.getItem('jwt_token'); 

            function parseJwt(token) {
                 try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }
            }

            if (!token) { window.location.href = '/auth'; return; }
            const decodedToken = parseJwt(token);
            if (!decodedToken || decodedToken.exp * 1000 < Date.now()) {
                localStorage.removeItem('jwt_token');
                window.location.href = '/auth';
                return;
            }
            const userName = decodedToken.name || 'User';
            const currentUserId = decodedToken.user_id; // Store current user's ID

            // --- UI ELEMENTS ---
            const leadsTbody = document.getElementById('leads-tbody');
            const leadDetailsPanel = document.getElementById('lead-details-panel');
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('toggleBtn');
            const salesMenu = document.getElementById('salesMenu');
            const crmMenu = document.getElementById('crmMenu');
            const logoutBtn = document.getElementById('logout-btn');
            const settingsBtn = document.getElementById('settings-btn');
            const logoImg = document.querySelector('.logo-img');


            // --- NEW: Pagination state ---
            let currentPage = 1;
            let limit = 50; // Match backend default
            let totalLeads = 0;
            let isLoadingLeads = false; // Prevent multiple simultaneous loads

            // --- API HELPER ---
            async function apiRequest(endpoint, method = 'GET', body = null) {
                const options = { method, headers: { 'Authorization': `Bearer ${token}` } };
                if (body) {
                    options.headers['Content-Type'] = 'application/json';
                    options.body = JSON.stringify(body);
                }
                const response = await fetch(endpoint, options);
                if (!response.ok) {
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.message || JSON.stringify(errorData);
                    } catch(e) { /* Ignore parsing error */ }
                    throw new Error(errorMsg);
                }
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                     // Check for empty body before parsing JSON
                    const text = await response.text();
                    return text ? JSON.parse(text) : null;
                } else {
                    return null;
                }
            }


            // --- DATA FETCHING & INITIALIZATION ---
            async function initializeApp() {
                 // Set profile name in sidebar
                 const profileNameEl = document.getElementById('profile-name');
                 if (profileNameEl) profileNameEl.textContent = userName;
                await loadLeads(1); // Load the first page on initial load
            }

            // --- NEW: Function to Load Leads Page ---
            async function loadLeads(page) {
                if (isLoadingLeads) return;
                isLoadingLeads = true;
                console.log(`Loading leads page ${page}...`);
                if (page === 1) {
                    leadsTbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Loading leads...</td></tr>';
                }
                 // Optional: Add loading indicator for subsequent pages (e.g., infinite scroll placeholder)
                 // else { leadsTbody.innerHTML += '<tr><td colspan="7">Loading more...</td></tr>'; }

                try {
                    // Fetch paginated leads from the updated endpoint
                    const response = await apiRequest(`/presales/leads?page=${page}&limit=${limit}`);

                    if (!response || !response.data) {
                         throw new Error("Received invalid data from server.");
                    }

                    // Replace data only for the first page
                    if (page === 1) {
                        allLeadsData = response.data;
                    } else {
                        // Remove potential loading indicator before appending
                        const loadingRow = leadsTbody.querySelector('tr td[colspan="7"]');
                        if (loadingRow) loadingRow.parentElement.remove();
                        allLeadsData = allLeadsData.concat(response.data);
                    }
                    totalLeads = response.total;
                    currentPage = page;

                    renderLeadsTable(page === 1); // Render leads, indicate if it's a full replace

                    // --- Trigger background insight generation for the NEWLY loaded leads ---
                    generateMissingInsights(response.data);

                } catch (error) {
                    console.error("Failed to fetch leads:", error);
                    if (page === 1) { // Show error only if first page fails
                         leadsTbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Error loading leads: ${error.message}</td></tr>`;
                    } else {
                        // Handle error for subsequent pages
                        const loadingRow = leadsTbody.querySelector('tr td[colspan="7"]');
                         if (loadingRow) loadingRow.textContent = `Error loading more leads: ${error.message}`;
                    }
                } finally {
                    isLoadingLeads = false;
                }
            }

            // --- RENDER FUNCTIONS ---
            const getScoreBadge = (score) => {
                 if (!score || score === '...') return '<span class="skeleton" style="width: 50px; height: 1.2em; display: inline-block; vertical-align: middle;"></span>'; // Skeleton
                 // Handle explicit error value if backend sends it
                 if (score === 'Error') {
                     return `<span class="score-badge score-error" title="Error generating score" style="background-color: rgba(255,0,0,0.1); color: red;">⚠️ Error</span>`;
                 }
                 const scoreClass = String(score).toLowerCase(); // Ensure lowercase
                 return `<span class="score-badge score-${scoreClass}"> ● ${score}</span>`;
            };


            const renderLeadsTable = (isReplace = true) => {
                // Ensure tbody exists
                if (!leadsTbody) {
                     console.error("Leads table body not found!");
                     return;
                }

                if (allLeadsData.length === 0 && isReplace) {
                    leadsTbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No leads found.</td></tr>';
                    return;
                }

                // Generate HTML for the leads to be rendered (either all or just the new page)
                const leadsToRender = isReplace ? allLeadsData : allLeadsData.slice((currentPage - 1) * limit);

                const leadsHtml = leadsToRender.map(lead => {
                    // Basic check for lead structure
                    if (!lead || typeof lead !== 'object') {
                         console.warn("Skipping invalid lead data:", lead);
                         return ''; // Skip rendering this item
                    }
                     // Use current user's name as placeholder owner for now
                    const ownerName = userName; // Replace later if owner info is fetched

                    return `
                    <tr data-lead-id="${lead.id}">
                        <td><input type="checkbox"></td>
                        <td>${lead.name || 'N/A'}</td>
                        <td>${lead.organization_name || 'N/A'}</td>
                        <td>${lead.status || 'N/A'}</td>

                        <td class="score-cell">${getScoreBadge(lead.lead_score)}</td>
                        
                        <td>${ownerName}</td>

                        <td class="actions-cell">
                            <button class="regenerate-btn" data-lead-id="${lead.id}">Regen AI</button>
                        </td>
                    </tr>
                `}).join('');

                if (isReplace) {
                    leadsTbody.innerHTML = leadsHtml;
                } else {
                    // Append logic for infinite scroll
                    leadsTbody.innerHTML += leadsHtml;
                }
            };

            // --- NEW: Function to Generate Missing Insights in Background ---
            async function generateMissingInsights(leadsToCheck) {
                if (!Array.isArray(leadsToCheck)) {
                     console.warn("generateMissingInsights called with invalid data type:", leadsToCheck);
                     return;
                }
                console.log(`Checking ${leadsToCheck.length} leads for missing insights...`);
                const insightPromises = [];

                for (const lead of leadsToCheck) {
                    // Check if insight is missing, null, empty string, or the specific placeholder
                    const needsInsight = !lead.ai_insight || String(lead.ai_insight).trim() === '' || lead.ai_insight === 'No insight generated yet.';

                    if (needsInsight) {
                        const leadId = lead.id;
                        // Find the row and score cell *before* the async call
                        const row = leadsTbody.querySelector(`tr[data-lead-id="${leadId}"]`);
                        const scoreCell = row ? row.querySelector('.score-cell') : null;

                        // Update UI immediately to show loading state ONLY if it's not already loading
                        if (scoreCell && !scoreCell.querySelector('.skeleton')) {
                            scoreCell.innerHTML = getScoreBadge('...'); // Show skeleton badge
                        }

                        // Create the promise for the API call
                        const promise = apiRequest(`/leads/${leadId}/generate_insight`, 'POST')
                            .then(updatedLead => {
                                 if (!updatedLead || typeof updatedLead !== 'object') {
                                      throw new Error("Invalid lead data received from server after insight generation.");
                                 }
                                // Update local data store (find and replace/update)
                                const index = allLeadsData.findIndex(l => l.id === leadId);
                                if (index !== -1) {
                                    allLeadsData[index] = updatedLead; // Replace with full updated lead object
                                }

                                // Update the specific row in the table (re-select for safety)
                                const currentRow = leadsTbody.querySelector(`tr[data-lead-id="${leadId}"]`);
                                const currentScoreCell = currentRow ? currentRow.querySelector('.score-cell') : null;
                                if (currentScoreCell) {
                                    // *** BUG FIX: Use updatedLead.lead_score ***
                                    currentScoreCell.innerHTML = getScoreBadge(updatedLead.lead_score);
                                }
                                console.log(`Insight generated & UI updated for lead ${leadId}`);

                                // Optional: If this lead's panel is currently open, refresh it
                                const activeRow = document.querySelector('#leads-tbody tr.active');
                                if (activeRow && parseInt(activeRow.dataset.leadId, 10) === leadId) {
                                    renderLeadDetails(updatedLead); // Re-render panel with new data
                                }
                            })
                            .catch(error => {
                                console.error(`Failed to generate insight for lead ${leadId}:`, error);
                                // Update the cell to show error state (re-select for safety)
                                const currentRow = leadsTbody.querySelector(`tr[data-lead-id="${leadId}"]`);
                                const currentScoreCell = currentRow ? currentRow.querySelector('.score-cell') : null;
                                if (currentScoreCell) {
                                   currentScoreCell.innerHTML = getScoreBadge('Error'); // Show error badge
                                }
                            });
                        insightPromises.push(promise);
                    }
                }

                // Don't await - let them run in the background
                console.log(`Dispatched ${insightPromises.length} insight generation requests.`);
            }

            // --- RENDER LEAD DETAILS (Modified for Skeletons) ---
            const renderLeadDetails = (lead) => {
                if (!lead) {
                    console.warn("renderLeadDetails called with null/undefined lead");
                    leadDetailsPanel.innerHTML = '<div class="panel-header"><p>Select a lead to see details.</p></div>';
                    return;
                }
                const aiTasks = lead.ai_tasks || {};
                // Check for loading state or actual missing data
                const insightIsLoadingOrMissing = !lead.ai_insight || lead.ai_insight === 'No insight generated yet.' || String(lead.ai_insight).trim() === '';
                const actionIsLoadingOrMissing = !lead.ai_next_action || lead.ai_next_action === 'Generating...' || String(lead.ai_next_action).trim() === '';

                const insightSkeleton = `<div class="skeleton skeleton-text" style="width: 90%; height: 1.2em;"></div><div class="skeleton skeleton-text" style="width: 75%; height: 1.2em;"></div>`;
                const actionSkeleton = `<div class="skeleton skeleton-text" style="width: 100%; height: 1.2em;"></div>`;

                leadDetailsPanel.innerHTML = `
                    <div class="panel-header">
                        <button id="close-panel-btn" class="lg:hidden">&times;</button>
                        <h2>${lead.name || 'N/A'}</h2>
                        <p>${lead.email || 'No Email'}</p>
                        
                        <button id="panel-regenerate-btn" class="panel-action-button" style="font-size: 0.8em; padding: 5px 10px; margin-top: 10px; background: rgba(0,0,0,0.1); color: #000;">
                            Regenerate AI
                        </button>

                        <div class="ai-insight">
                            <strong>AI Insight:</strong>
                            <span id="ai-insight-text">${insightIsLoadingOrMissing ? insightSkeleton : (lead.ai_insight || 'N/A')}</span>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="panel-section">
                            <h3>AI Task Control</h3>
                            <div class="task-control-grid">
                                ${['Calls', 'Emails', 'Scheduling', 'Follow-ups', 'Summaries', 'Nurturing'].map(task => `
                                <div class="task-control-item">
                                    <label for="task-${task.toLowerCase()}">${task}</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" class="ai-task-toggle" data-task="${task}" id="task-${task.toLowerCase()}" ${aiTasks[task] ? 'checked' : ''}>
                                        <span class="slider"></span>
                                    </label>
                                </div>`).join('')}
                            </div>
                        </div>
                        <div class="panel-section">
                            <h3>Next Best Action</h3>
                            <div class="action-item" id="next-best-action-container">
                                ${actionIsLoadingOrMissing ? actionSkeleton : `<p>${lead.ai_next_action || 'N/A'}</p>`}
                            </div>
                        </div>
                        <div class="panel-section">
                            <h3>Instruct AI</h3>
                            <textarea id="ai-instruction-input" rows="3" placeholder="e.g., Draft a follow-up email focusing on our key differentiators..."></textarea>
                            <div style="text-align: right; margin-top: 10px;">
                                <button id="instruct-ai-btn" class="panel-action-button">Send Instruction</button>
                            </div>
                            <div id="ai-instruction-response" class="ai-insight" style="margin-top: 15px; display: none; white-space: pre-wrap; word-wrap: break-word;"></div>
                        </div>
                    </div>
                `;
                leadDetailsPanel.classList.remove('hidden');
                // Handle responsive panel visibility
                if (window.innerWidth <= 1024) {
                    leadDetailsPanel.classList.add('active');
                } else {
                     leadDetailsPanel.classList.remove('active'); // Ensure it's not active on wider screens
                }
                attachPanelEventListeners(lead.id); // Re-attach listeners
            };


            // --- *** NEW: FUNCTION TO HANDLE REGENERATION *** ---
            async function handleRegenerateClick(leadId) {
                if (!leadId) return;

                // Find all buttons related to this lead and set loading state
                const tableBtn = leadsTbody.querySelector(`.regenerate-btn[data-lead-id="${leadId}"]`);
                const panelBtn = document.getElementById('panel-regenerate-btn'); // Only one panel button
                const scoreCell = leadsTbody.querySelector(`tr[data-lead-id="${leadId}"] .score-cell`);

                if (tableBtn) { tableBtn.disabled = true; tableBtn.innerText = '...'; }
                // Check if panel button exists and belongs to this lead
                const activeRow = document.querySelector('#leads-tbody tr.active');
                if (panelBtn && activeRow && activeRow.dataset.leadId == leadId) {
                    panelBtn.disabled = true; panelBtn.innerText = 'Loading...';
                }
                if (scoreCell) { scoreCell.innerHTML = getScoreBadge('...'); } // Show skeleton
                
                // If panel is open for this lead, show skeletons inside
                if (activeRow && activeRow.dataset.leadId == leadId) {
                    const insightText = document.getElementById('ai-insight-text');
                    const actionContainer = document.getElementById('next-best-action-container');
                    if (insightText) insightText.innerHTML = `<div class="skeleton skeleton-text" style="width: 90%;"></div><div class="skeleton skeleton-text" style="width: 75%;"></div>`;
                    if (actionContainer) actionContainer.innerHTML = `<div class="skeleton skeleton-text" style="width: 100%;"></div>`;
                }


                try {
                    // Call your existing endpoint
                    const updatedLead = await apiRequest(`/leads/${leadId}/generate_insight`, 'POST');
                    
                    if (!updatedLead || typeof updatedLead !== 'object') {
                        throw new Error("Invalid lead data received from server.");
                    }

                    // 1. Update local data store
                    const index = allLeadsData.findIndex(l => l.id == leadId);
                    if (index !== -1) {
                        allLeadsData[index] = updatedLead;
                    }

                    // 2. Update table row
                    if (scoreCell) {
                        scoreCell.innerHTML = getScoreBadge(updatedLead.lead_score);
                    }

                    // 3. Check if panel is open for this lead and refresh it
                    const currentlyActiveRow = document.querySelector('#leads-tbody tr.active');
                    if (currentlyActiveRow && currentlyActiveRow.dataset.leadId == leadId) {
                        renderLeadDetails(updatedLead);
                    }

                } catch (error) {
                    console.error(`Failed to regenerate insight for lead ${leadId}:`, error);
                    alert(`Error: ${error.message}`);
                    if (scoreCell) { scoreCell.innerHTML = getScoreBadge('Error'); }
                    // If panel is open, re-render with the old data to remove skeletons
                    const index = allLeadsData.findIndex(l => l.id == leadId);
                    if (index !== -1) renderLeadDetails(allLeadsData[index]);

                } finally {
                    // Reset buttons
                    if (tableBtn) { tableBtn.disabled = false; tableBtn.innerText = 'Regen AI'; }
                    if (panelBtn && activeRow && activeRow.dataset.leadId == leadId) {
                        panelBtn.disabled = false; panelBtn.innerText = 'Regenerate AI';
                    }
                }
            }


            // --- EVENT HANDLERS ---
            function attachPanelEventListeners(leadId) {
                // Close button
                const closeBtn = document.getElementById('close-panel-btn');
                if (closeBtn) {
                     closeBtn.removeEventListener('click', closePanel, true);
                     closeBtn.addEventListener('click', closePanel, true);
                }

                // *** NEW: Add listener for panel regenerate button ***
                const panelRegenBtn = document.getElementById('panel-regenerate-btn');
                if (panelRegenBtn) {
                    panelRegenBtn.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent any other clicks
                        handleRegenerateClick(leadId);
                    });
                }


                // AI Task Toggles
                document.querySelectorAll('.ai-task-toggle').forEach(toggle => {
                     const newToggle = toggle.cloneNode(true);
                     toggle.parentNode.replaceChild(newToggle, toggle);

                     newToggle.addEventListener('change', async (e) => {
                        const task = e.target.dataset.task;
                        const enabled = e.target.checked;
                        console.log(`Toggling task ${task} for lead ${leadId} to ${enabled}`);
                        try {
                            await apiRequest(`/leads/${leadId}/ai_tasks`, 'PUT', { task, enabled });
                            // Update local data store
                            const leadIndex = allLeadsData.findIndex(l => l.id === leadId);
                            if (leadIndex !== -1) {
                                if (!allLeadsData[leadIndex].ai_tasks) allLeadsData[leadIndex].ai_tasks = {};
                                allLeadsData[leadIndex].ai_tasks[task] = enabled;
                            }
                        } catch (error) {
                            console.error(`Failed to update task ${task}:`, error);
                            alert(`Could not update task state for ${task}. Please try again.`);
                            e.target.checked = !enabled; // Revert UI
                        }
                    });
                 });

                // Instruct AI Button
                 const instructBtn = document.getElementById('instruct-ai-btn');
                 if (instructBtn) {
                     const newInstructBtn = instructBtn.cloneNode(true);
                     instructBtn.parentNode.replaceChild(newInstructBtn, instructBtn);

                     newInstructBtn.addEventListener('click', async (e) => {
                        const btn = e.target;
                        const instructionInput = document.getElementById('ai-instruction-input');
                        const responseContainer = document.getElementById('ai-instruction-response');
                        const instruction = instructionInput ? instructionInput.value.trim() : '';

                        if (!instruction) { /* ... (error handling) ... */ return; }

                        btn.textContent = 'Processing...';
                        btn.disabled = true;
                        if (responseContainer) { responseContainer.style.display = 'none'; responseContainer.style.borderColor = 'rgba(0,0,0,0.1)'; }

                        try {
                             // --- TEMPORARY MOCK RESPONSE ---
                             await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate delay
                             const result = { response: `Mock response for instruction on lead ${leadId}: "${instruction}"`};
                             // --- END MOCK ---

                            let responseText = result?.response || result?.message || JSON.stringify(result, null, 2) || "No response content.";
                            if (responseContainer) {
                                responseContainer.innerHTML = `<strong>AI Response:</strong><br>${responseText.replace(/\n/g, '<br>')}`;
                                responseContainer.style.display = 'block';
                            }
                        } catch (error) {
                            console.error("AI instruction failed:", error);
                             if (responseContainer) {
                                responseContainer.innerHTML = `<strong>Error:</strong> ${error.message}`;
                                responseContainer.style.display = 'block';
                                responseContainer.style.borderColor = '#f87171';
                             } else { alert(`Error sending instruction: ${error.message}`); }
                        } finally {
                            btn.textContent = 'Send Instruction';
                            btn.disabled = false;
                        }
                     });
                 } else { console.warn("Instruct AI button not found after render."); }
            }


            function closePanel() {
                leadDetailsPanel.classList.add('hidden'); // Use class for animation
                if (window.innerWidth <= 1024) {
                    leadDetailsPanel.classList.remove('active');
                }
                document.querySelector('#leads-tbody tr.active')?.classList.remove('active');
            }

            // --- MODIFIED: Row Click Handler (No Insight Generation Here) ---
            const handleRowClick = (e) => {
                const row = e.target.closest('tr');

                // *** NEW: Check for regenerate button click first ***
                if (e.target.classList.contains('regenerate-btn')) {
                    e.stopPropagation(); // Stop the row click from propagating
                    const leadId = e.target.dataset.leadId;
                    handleRegenerateClick(leadId);
                    return; // Stop execution
                }

                // Ignore clicks on checkbox or if panel is already open and clicked inside
                if (!row || !row.dataset.leadId || e.target.tagName === 'INPUT') return;

                 // Prevent panel closure if clicking inside panel area
                 if (leadDetailsPanel.contains(e.target)) return;

                const leadId = parseInt(row.dataset.leadId, 10);
                const leadData = allLeadsData.find(l => l.id === leadId);

                if (leadData) {
                    // Deselect previous row, select current row
                    document.querySelectorAll('#leads-tbody tr.active').forEach(tr => tr.classList.remove('active'));
                    row.classList.add('active');

                    // Render details using locally stored (potentially updated by background process) data
                    renderLeadDetails(leadData);
                } else {
                    console.warn(`Lead data not found locally for ID: ${leadId}.`);
                     row.querySelector('.score-cell').innerHTML = getScoreBadge('Error');
                }
            };


            // --- INITIALIZE & GLOBAL LISTENERS ---
             if (toggleBtn) toggleBtn.addEventListener('click', () => { sidebar.classList.toggle('hidden'); toggleBtn.classList.toggle('visible'); });
             if (salesMenu) salesMenu.addEventListener('click', (e) => { e.stopPropagation(); salesMenu.classList.toggle('open'); });
             if (crmMenu) crmMenu.addEventListener('click', (e) => { e.stopPropagation(); crmMenu.classList.toggle('open'); });
             if (logoutBtn) logoutBtn.addEventListener('click', () => { localStorage.removeItem('jwt_token'); window.location.href = '/auth'; });
             if (settingsBtn) settingsBtn.addEventListener('click', () => { window.location.href = '/settings'; });
             if (logoImg) logoImg.addEventListener('click', () => { window.location.href = '/'; });

            // Attach row click listener to the table body
            leadsTbody.addEventListener('click', handleRowClick);

            // Close panel if clicking outside of it (on main content area)
            document.querySelector('.main-content').addEventListener('click', (e) => {
                 // Check if click is outside the panel AND outside the table rows
                 if (!leadDetailsPanel.contains(e.target) && !leadsTbody.contains(e.target)) {
                     closePanel();
                 }
             });

            // Initial data load
            initializeApp();

            // --- Optional: Add infinite scrolling or pagination controls ---
            // const tableContainer = document.querySelector('.table-container');
            // tableContainer.addEventListener('scroll', () => { /* ... load more logic ... */ });
        });
    </script>
</body>
</html>